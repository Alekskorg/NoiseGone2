<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoiseGone — очистка аудио от шума</title>
  <meta name="description" content="NoiseGone — онлайн‑сервис для удаления фонового шума из аудио. Загрузите файл и скачайте очищенную версию." />
  <link rel="icon" href="favicon.ico" />
  <style>
    *{box-sizing:border-box}
    :root{
      --bg1:#eaf4ff; --bg2:#f2eaff;
      --card:#fff; --text:#111; --muted:#666;
      --brand:#2563eb; --ok:#2ca052; --err:#c62828; --border:#d8deea;
    }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      font:16px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--text)
    }
    .card{
      width:min(92vw,460px); background:var(--card); border-radius:20px;
      padding:28px 28px 24px; box-shadow:0 12px 34px rgba(0,0,0,.08);
      position:relative; text-align:center
    }
    .logo{width:112px; margin:6px auto 14px; display:block}
    #lang{position:absolute; top:12px; right:12px; border:0; background:#f5f7fb; border-radius:12px; padding:6px 10px;
      font-weight:700; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,.08)}
    h1{margin:0 0 6px; font-size:30px; letter-spacing:.2px}
    .desc{margin:0 0 18px; color:var(--muted)}
    .modes{display:flex; gap:8px; margin:0 0 12px}
    .modes button{
      flex:1; min-width:0; padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer
    }
    .modes button.active{background:var(--brand); color:#fff; border-color:var(--brand)}
    .drop{
      border:2px dashed #9db6e3; border-radius:12px; padding:0 16px; margin:12px 0 14px; cursor:pointer;
      transition:.15s; min-height:120px; display:flex; align-items:center; justify-content:center; text-align:center
    }
    .drop.hover{background:#eef6ff; border-color:var(--brand)}
    .hint-top{font-weight:600; margin-bottom:4px}
    .hint-sub{color:var(--muted); font-size:13px}
    .file-line{display:flex; align-items:center; gap:10px; justify-content:center}
    .file-name{max-width:270px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .file-size{color:var(--muted); font-size:12px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; border:0; border-radius:999px;
      padding:12px 18px; font-size:16px; cursor:pointer}
    #go{width:100%; background:var(--ok); color:#fff; margin:8px 0 10px}
    #go:disabled{opacity:.6; cursor:not-allowed}
    #new{display:none; background:#eef1f6; margin-right:8px}
    #cancel{display:none; background:#ffd5d5; color:#982a2a}
    .bar-wrap{height:8px; background:#eef1f6; border-radius:6px; overflow:hidden; margin:12px 0 8px; display:none}
    .bar{height:100%; width:0; background:var(--ok); transition:width .2s}
    .status{min-height:22px; font-size:14px}
    .status.err{color:var(--err)}
    #download{display:none; margin-top:6px}
    #download a{color:var(--brand); font-weight:700; text-decoration:none}
    .small{margin-top:12px; color:var(--muted); font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <button id="lang" type="button">EN</button>

    <img class="logo" src="logo.png" alt="NoiseGone logo" />
    <h1>NoiseGone</h1>
    <p class="desc">Загрузите аудиофайл, и мы удалим шум</p>

    <div class="modes" id="modes">
      <button class="active" data-preset="podcast">Podcast</button>
      <button data-preset="interview">Interview</button>
      <button data-preset="voiceover">Voice‑over</button>
      <button data-preset="field">Field</button>
    </div>

    <div id="drop" class="drop" role="button" tabindex="0" aria-label="file drop zone">
      <div>
        <div class="hint-top">Перетащите аудио сюда или нажмите, чтобы выбрать</div>
        <div class="hint-sub">Поддерживаемые: WAV, MP3, M4A (до ~50 МБ)</div>
      </div>
    </div>
    <input id="file" type="file" accept="audio/*" hidden />

    <div style="display:flex; gap:8px; justify-content:center">
      <button id="new" class="btn" type="button">Новый файл</button>
      <button id="cancel" class="btn" type="button">Отмена</button>
    </div>
    <button id="go" class="btn" type="button" disabled>Очистить шум</button>

    <div class="bar-wrap" id="barWrap"><div class="bar" id="bar"></div></div>
    <div id="status" class="status"></div>

    <div id="download"><a id="dl" href="#" download="cleaned.mp3">Скачать очищенный файл</a></div>
    <p class="small" id="plan">Бесплатно — до 5 минут/день. Для больших объёмов будет поминутная оплата.</p>
  </div>

  <script>
    (function(){
      // -------- i18n --------
      const T = {
        ru:{
          desc:'Загрузите аудиофайл, и мы удалим шум',
          hintTop:'Перетащите аудио сюда или нажмите, чтобы выбрать',
          hintSub:'Поддерживаемые: WAV, MP3, M4A (до ~50 МБ)',
          clean:'Очистить шум',
          newFile:'Новый файл',
          cancel:'Отмена',
          free:'Бесплатно — до 5 минут/день. Для больших объёмов будет поминутная оплата.',
          processing:'Идёт обработка…',
          done:'Готово! Кликните, чтобы скачать.',
          downloading:'Скачать очищенный файл',
          net:'Сетевая ошибка',
          tooBig:'Файл больше 50 МБ',
          noFile:'Сначала выберите файл'
        },
        en:{
          desc:"Upload an audio file and we'll remove the noise",
          hintTop:'Drag & drop audio here or click to choose',
          hintSub:'Supported: WAV, MP3, M4A (up to ~50 MB)',
          clean:'Clean noise',
          newFile:'New file',
          cancel:'Cancel',
          free:'Free — up to 5 minutes/day. Large volume billed per minute.',
          processing:'Processing…',
          done:'Done! Click to download.',
          downloading:'Download cleaned file',
          net:'Network error',
          tooBig:'File exceeds 50 MB',
          noFile:'Please choose a file first'
        }
      };
      let lang = (document.documentElement.lang || 'ru').startsWith('en') ? 'en' : 'ru';
      let preset = 'podcast';
      let fileObj = null;
      let xhr = null;

      // -------- DOM --------
      const $ = id => document.getElementById(id);
      const langBtn = $('lang');
      const desc = document.querySelector('.desc');
      const modes = [...document.querySelectorAll('#modes button')];
      const drop = $('drop'), file = $('file');
      const newBtn = $('new'), cancelBtn = $('cancel'), goBtn = $('go');
      const barWrap = $('barWrap'), bar = $('bar'), status = $('status');
      const downloadWrap = $('download'), dl = $('dl'), plan = $('plan');

      function setLang(l){
        lang = l;
        document.documentElement.lang = l;
        langBtn.textContent = (l==='ru'?'EN':'RU');
        const L = T[l];
        desc.textContent = L.desc;
        plan.textContent = L.free;
        goBtn.textContent = L.clean;
        newBtn.textContent = L.newFile;
        cancelBtn.textContent = L.cancel;
        if(!fileObj){
          drop.innerHTML = `<div><div class="hint-top">${L.hintTop}</div><div class="hint-sub">${L.hintSub}</div></div>`;
        }
        dl.textContent = L.downloading;
      }
      setLang(lang);
      langBtn.addEventListener('click', ()=> setLang(lang==='ru'?'en':'ru'));

      // -------- Modes --------
      modes.forEach(b => b.addEventListener('click', ()=>{
        modes.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        preset = b.dataset.preset || 'podcast';
      }));

      // -------- Helpers --------
      const bytes = n => {
        const u=['B','KB','MB','GB']; let i=0,v=n;
        while(v>=1024&&i<u.length-1){v/=1024;i++}
        return `${v.toFixed(1)} ${u[i]}`
      };
      function showFile(){
        const L = T[lang];
        if(!fileObj){
          drop.innerHTML = `<div><div class="hint-top">${L.hintTop}</div><div class="hint-sub">${L.hintSub}</div></div>`;
          goBtn.disabled = true;
          newBtn.style.display='none';
          cancelBtn.style.display='none';
          return;
        }
        drop.innerHTML =
          `<div>
             <div class="file-line">
               <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="#2563eb" d="M12 3l8 6v12H4V9l8-6zm0 2.3L6 10v9h12v-9l-6-4.7z"/></svg>
               <span class="file-name" title="${fileObj.name}">${fileObj.name}</span>
               <span class="file-size">(${bytes(fileObj.size)})</span>
             </div>
             <div class="hint-sub">${L.hintSub}</div>
           </div>`;
        goBtn.disabled = false;
        newBtn.style.display='inline-flex';
        cancelBtn.style.display='none';
      }
      function resetUI(hard=false){
        if(hard){ file.value=''; fileObj=null; }
        goBtn.disabled = !fileObj;
        bar.style.width='0%'; barWrap.style.display='none';
        status.textContent=''; status.classList.remove('err');
        downloadWrap.style.display='none';
        cancelBtn.style.display='none';
        showFile();
      }

      // -------- File select / drop --------
      drop.addEventListener('click', ()=> file.click());
      drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('hover'); });
      drop.addEventListener('dragleave', ()=> drop.classList.remove('hover'));
      drop.addEventListener('drop', e=>{
        e.preventDefault(); drop.classList.remove('hover');
        const f = e.dataTransfer?.files?.[0];
        if(!f) return;
        if(f.size > 50*1024*1024){ status.textContent = T[lang].tooBig; status.classList.add('err'); return; }
        fileObj = f; resetUI(); showFile();
      });
      file.addEventListener('change', ()=>{
        const f = file.files?.[0];
        if(!f) return;
        if(f.size > 50*1024*1024){ status.textContent = T[lang].tooBig; status.classList.add('err'); file.value=''; return; }
        fileObj = f; resetUI(); showFile();
      });

      // -------- Cancel --------
      cancelBtn.addEventListener('click', ()=>{
        try{ xhr?.abort?.(); }catch(_){}
        status.textContent = '';
        cancelBtn.style.display='none';
        goBtn.disabled = false;
        barWrap.style.display='none';
      });

      // -------- New file --------
      newBtn.addEventListener('click', ()=> resetUI(true));

      // -------- Process --------
      goBtn.addEventListener('click', ()=>{
        if(!fileObj){ status.textContent=T[lang].noFile; status.classList.add('err'); return; }

        // UI state
        status.classList.remove('err');
        status.textContent = T[lang].processing;
        downloadWrap.style.display='none';
        goBtn.disabled = true;
        bar.style.width='0%'; barWrap.style.display='block';
        cancelBtn.style.display='inline-flex';

        // формируем запрос
        const form = new FormData();
        form.append('file', fileObj);
        form.append('preset', preset);

        // XHR для прогресса
        xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/clean');
        xhr.responseType = 'blob';
        xhr.timeout = 120000; // 28с ожидания сети (сервер всё равно ограничен лимитом)

        // аплоад (0–50%)
        xhr.upload.onprogress = (e)=>{
          if(e.lengthComputable){
            const pct = Math.max(1, Math.round(e.loaded/e.total*50));
            bar.style.width = pct+'%';
          }
        };
        // «умный» фолбэк (50–95%), если сервер не сообщает размер ответа
        let fake = 50, fakeTimer = setInterval(()=>{
          if(fake < 95){ fake+=1; bar.style.width=fake+'%'; }
        }, 250);

        // download (реальное закрытие → 100%)
        xhr.onprogress = (e)=>{
          if(e.lengthComputable){
            clearInterval(fakeTimer);
            const pct = 50 + Math.round(e.loaded/e.total*50);
            bar.style.width = Math.min(100, pct) + '%';
          }
        };

        xhr.onload = ()=>{
          clearInterval(fakeTimer);
          bar.style.width = '100%';
          cancelBtn.style.display='none';
          goBtn.disabled = false;

          if(xhr.status !== 200){
            // показать текст ошибки с бэка
            const reader = new FileReader();
            reader.onload = ()=>{ status.textContent = (reader.result || `${xhr.status}`); status.classList.add('err'); };
            reader.readAsText(xhr.response || new Blob());
            return;
          }

          const type = xhr.getResponseHeader('Content-Type') || '';
          if(type.includes('text')){
            const reader = new FileReader();
            reader.onload = ()=>{ status.textContent = reader.result; status.classList.add('err'); };
            reader.readAsText(xhr.response);
            return;
          }

          // имя файла из Content-Disposition
          const cd = xhr.getResponseHeader('Content-Disposition') || '';
          const m = cd.match(/filename\*?=(?:UTF-8''|")?([^\";]+)/i);
          const fname = m ? decodeURIComponent(m[1]) : 'cleaned.mp3';

          const url = URL.createObjectURL(xhr.response);
          dl.href = url;
          dl.setAttribute('download', fname);
          downloadWrap.style.display = 'block';
          status.textContent = T[lang].done;
        };

        xhr.onerror = ()=>{
          clearInterval(fakeTimer);
          barWrap.style.display='none';
          goBtn.disabled = false;
          cancelBtn.style.display='none';
          status.textContent = T[lang].net;
          status.classList.add('err');
        };
        xhr.ontimeout = ()=>{
          clearInterval(fakeTimer);
          barWrap.style.display='none';
          goBtn.disabled = false;
          cancelBtn.style.display='none';
          status.textContent = T[lang].net + ' (timeout)';
          status.classList.add('err');
        };

        xhr.send(form);
      });
    })();
  </script>
</body>
</html>



